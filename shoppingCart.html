<!-- 
    Shopping Cart Template
    Main features: a template;
    Product display and add to cart (no real data)
    Shopping cart interface
    Add/reduce product quantity
    Delete items
    Calculate total price
-->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Buyzu Â· Shopping Cart</title>

<!-- ============ Styles ============ -->
<style>
  /* Reset */
  *, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
  body { font-family: Arial, sans-serif; background: #F7FFF7; color: #1A1F36; line-height:1.5; }
  a { color: inherit; text-decoration: none; }

  /* Utility */
  .container { width:90%; max-width:800px; margin:0 auto; padding:2rem 0; }
  .glass { background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); border-radius:12px; box-shadow:0 8px 32px rgba(0,0,0,0.1); }

   /* Header */
   header { position: sticky; top:0; z-index:100; background: rgba(255,255,255,0.8); backdrop-filter: blur(8px); }
   .nav-wrapper { display:flex; align-items:center; justify-content:space-between; padding:1rem 0; }
   .logo { font-size:1.5rem; font-weight:bold; color:#FF6B6B; }
   .search-cart { display:flex; align-items:center; gap:2rem; }
   .search-cart input { width:300px;padding:.5rem 1rem; border:none; border-radius:20px; background:#fff; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
   .search-cart button { 
     padding:.3rem 1rem; /* smaller button size */
     border:none; 
     border-radius:20px; 
     background:#FF6B6B; 
     color:#fff; 
     font-size:.85rem; 
     cursor:pointer; 
   }
   .search-cart .icon { font-size:1.5rem; cursor:pointer; }
   .auth-buttons { display:flex; gap:1rem; }
   .auth-buttons .btn { padding:.4rem .8rem; border-radius:20px; font-size:.9rem; cursor:pointer; transition:.25s; }
   .auth-buttons .login { background:transparent; border:1px solid #1A1F36; color:#1A1F36; }
   .auth-buttons .register { background:#FF6B6B; border:none; color:#fff; }
   .auth-buttons .btn:hover { opacity:.85; }
   .auth-buttons {
    display: flex;
    gap: 1rem;
    align-items: center; /* ensure all child elements are vertically centered */
  }
  .cart-icon {
    font-size: 1.5rem; /* adjust size */
    display: flex;
    align-items: center;
  }
  

  /* Main area */
  main { max-width:800px; margin:0 auto; padding:2rem 0; }
  .section-head { display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:1.5rem; }
  .section-head h2 { font-size:1.5rem; font-weight:700; }
  .empty-cart { text-align:center; padding:3rem 1rem; color:#6B7280; background:white; border-radius:12px; box-shadow:0 8px 32px rgba(0,0,0,0.1); }
  .empty-cart svg { width:64px; height:64px; fill:#6B7280; margin-bottom:1rem; }

  /* Cart list */
  .cart-list { background:#fff; border-radius:12px; overflow:hidden; box-shadow:0 8px 32px rgba(0,0,0,0.1); }
  .cart-header { display:grid; grid-template-columns:24px 100px 1fr 120px 100px 80px; padding:1rem; font-weight:600; border-bottom:1px solid #E5E7EB; background:#F0F1F3; }
  .cart-item { display:grid; grid-template-columns:24px 100px 1fr 120px 100px 80px; padding:1rem; border-bottom:1px solid #E5E7EB; align-items:center; }
  .cart-item:last-child { border-bottom:none; }
  .cart-item:hover { background:#F7FFF7; }

  /* Product image and info */
  .item-check { display:flex; align-items:center; justify-content:center; }
  .item-check input { width:18px; height:18px; cursor:pointer; }
  .item-img { padding:.25rem; }
  .item-img img { width:100%; aspect-ratio:1/1; object-fit:cover; border-radius:8px; background:#fafafa; }
  .item-info { padding:0 .5rem; }
  .item-name {
    font-weight: 600;
    display: -webkit-box;
    display: box;
    -webkit-line-clamp: 2;
    line-clamp: 2;
    -webkit-box-orient: vertical;
    box-orient: vertical;
    overflow: hidden;
  }
  .item-brand { font-size:.85rem; color:#6B7280; margin-top:.25rem; }

  /* Quantity adjustment */
  .item-quantity { display:flex; align-items:center; border:1px solid #E5E7EB; border-radius:8px; overflow:hidden; }
  .quantity-btn { width:32px; height:32px; display:flex; align-items:center; justify-content:center; background:none; border:none; cursor:pointer; }
  .quantity-btn:hover { background:#F0F1F3; }
  .quantity-btn svg { width:16px; height:16px; fill:#6B7280; }
  .quantity-input { width:40px; height:32px; border:none; text-align:center; font-size:.9rem; }
  .quantity-input:focus { outline:none; }

  /* Price and actions */
  .item-price { font-weight:600; color:#FF6B6B; }
  .item-actions { display:flex; justify-content:center; }
  .delete-btn { background:none; border:none; cursor:pointer; color:#6B7280; display:flex; align-items:center; justify-content:center; padding:.5rem; }
  .delete-btn:hover { color:#FF6B6B; }
  .delete-btn svg { width:18px; height:18px; fill:currentColor; }

  /* Checkout area */
  .cart-footer { margin-top:1.5rem; background:#fff; border-radius:12px; padding:1.2rem; box-shadow:0 8px 32px rgba(0,0,0,0.1); }
  .cart-summary { display:flex; justify-content:space-between; align-items:center; }
  .summary-left { display:flex; align-items:center; gap:.75rem; }
  .select-all { display:flex; align-items:center; gap:.5rem; }
  .select-all input { width:18px; height:18px; cursor:pointer; }
  .summary-actions { display:flex; gap:.5rem; }
  .summary-actions button { background:none; border:none; color:#6B7280; cursor:pointer; font-size:.9rem; }
  .summary-actions button:hover { color:#FF6B6B; }
  .summary-right { display:flex; align-items:center; gap:1.5rem; }
  .total-price { font-size:1.1rem; font-weight:700; color:#FF6B6B; }
  .checkout-btn { background:#FF6B6B; color:#fff; border:none; border-radius:30px; padding:.75rem 1.5rem; font-weight:600; cursor:pointer; transition:.25s; }
  .checkout-btn:hover { opacity:.85; }

  /* Enter animation */
  @keyframes fadeIn {
    0% { opacity:0; transform:translateY(10px); }
    100% { opacity:1; transform:none; }
  }
  .fade-in { animation:fadeIn .35s ease-out both; }

  /* Responsive adjustments */
  @media(max-width:768px) {
    .cart-header { display:none; }
    .cart-item {
      grid-template-columns:24px 80px 1fr;
      grid-template-areas:
        "check img info"
        "check img price"
        "check img quantity"
        "check img actions";
      gap:.5rem;
    }
    .item-check { grid-area:check; }
    .item-img { grid-area:img; }
    .item-info { grid-area:info; }
    .item-price { grid-area:price; }
    .item-quantity { grid-area:quantity; width:120px; }
    .item-actions { grid-area:actions; justify-content:flex-start; }
    
    .cart-summary { flex-direction:column; align-items:flex-start; gap:1rem; }
    .summary-right { width:100%; justify-content:space-between; }
  }
</style>
</head>

<body>

<header>
  <div class="nav-wrapper container">
    <a href="homepage.html" class="logo">Buyzu</a>
  <div class="search-cart">
    <input type="text" id="searchInput" placeholder="Searchâ€¦">
    <button onclick="redirectToSearch()">Search</button>
  </div>
    <div class="auth-buttons">
      <button class="btn login">Login</button>
      <button class="btn register">Register</button>
      <a href="shoppingCart.html" class="cart-icon">ðŸ›’</a>
    </div>
  </div>
</header>

<main class="container">
  <section>
    <div class="section-head">
      <h2>My Shopping Cart</h2>
    </div>

    <div id="cartContainer">
      <!-- Cart content will be loaded dynamically via JS -->
    </div>
  </section>
</main>

<footer>
  <div class="container" style="text-align:center; padding:2rem 0; color:#6b7280;">
    &copy; 2025 Buyzu. All rights reserved.
  </div>
</footer>

<!-- ============ Scripts ============ -->
<script>
/* ---------- Constants ---------- */
const API_CART = '/api/cart';
const API_PRODUCTS = '/api/products';
const cartContainer = document.getElementById('cartContainer');

/*This is a temporary dataset. Modify when connecting to database. Receive data -> from product page*/
// Sample product data
const DEMO_PRODUCTS = [
  {
    product_id: '1',
    name: 'Apple AirPods Pro (2nd Generation)',
    brandName: 'Apple',
    price: 1899.00,
    quantity: 1,
    img: 'p1.jpeg',
    checked: true
  },
  {
    product_id: '6',
    name: 'Sony WF-1000XM5 Wireless Noise Cancelling Earbuds',
    brandName: 'Sony',
    price: 1599.00,
    quantity: 2,
    img: 'p6.jpeg',
    checked: true
  },
  {
    product_id: '21',
    name: 'HUAWEI FreeClip Open-ear Wireless Earbuds',
    brandName: 'HUAWEI',
    price: 1199.00,
    quantity: 1,
    img: 'p21.jpeg',
    checked: false
  }
];

let cartItems = [];
let allProducts = [];
let isDemo = true; // Flag to indicate if using demo data

/* ---------- Cookie ---------- */
function getCookie(n){const m=document.cookie.match('(?:^|; )'+n+'=([^;]+)');return m?decodeURIComponent(m[1]):null;}
function setCookie(n,v,d=365){document.cookie=`${n}=${encodeURIComponent(v)}; expires=${new Date(Date.now()+d*864e5).toUTCString()}; path=/`;} 
function genAnon(){return 'sess_'+Date.now().toString(36)+'_'+Math.random().toString(16).slice(2,6);}

/* ---------- Render Empty Cart ---------- */
function renderEmptyCart() {
  cartContainer.innerHTML = `
    <div class="empty-cart fade-in">
      <svg viewBox="0 0 24 24">
        <path d="M16.2 4H19c.6 0 1 .4 1 1v1H4V5c0-.6.4-1 1-1h2.8l.6-1.1C8.7 2.4 9.2 2 9.8 2h4.4c.6 0 1.1.4 1.4.9L16.2 4zM3 8h18v12c0 1.1-.9 2-2 2H5c-1.1 0-2-.9-2-2V8zm7 3v6c0 .6.4 1 1 1s1-.4 1-1v-6c0-.6-.4-1-1-1s-1 .4-1 1zm4 0v6c0 .6.4 1 1 1s1-.4 1-1v-6c0-.6-.4-1-1-1s-1 .4-1 1z"/>
      </svg>
      <p>Your cart is empty. Start shopping now!</p>
    </div>
  `;
}

/* ---------- Render Cart List ---------- */
function renderCart() {
  if (!cartItems || cartItems.length === 0) {
    renderEmptyCart();
    return;
  }

  // Calculate total price
  const totalPrice = cartItems.reduce((sum, item) => {
    return item.checked ? sum + (item.price * item.quantity) : sum;
  }, 0);

  // Check if all items are selected
  const allChecked = cartItems.length > 0 && cartItems.every(item => item.checked);
  
  // Build HTML
  let html = `
    <div class="cart-list fade-in">
      <div class="cart-header">
        <div class="item-check">Select</div>
        <div></div>
        <div>Product Info</div>
        <div>Price</div>
        <div>Quantity</div>
        <div>Action</div>
      </div>
  `;

  // Add each product
  cartItems.forEach(item => {
    html += `
      <div class="cart-item" data-id="${item.product_id}">
        <div class="item-check">
          <input type="checkbox" ${item.checked ? 'checked' : ''} onchange="toggleItemCheck('${item.product_id}')">
        </div>
        <div class="item-img">
          <img src="${isDemo ? `https://picsum.photos/id/${item.product_id*10}/200` : `/images/${item.img || 'default.jpg'}`}" alt="${item.name}">
        </div>
        <div class="item-info">
          <div class="item-name">${item.name}</div>
          <div class="item-brand">${item.brandName || ''}</div>
        </div>
        <div class="item-price">HK$${(+item.price).toFixed(2)}</div>
        <div class="item-quantity">
          <button class="quantity-btn" onclick="updateQuantity('${item.product_id}', -1)">
            <svg viewBox="0 0 24 24"><path d="M5 13v-2h14v2z"/></svg>
          </button>
          <input type="number" class="quantity-input" value="${item.quantity}" min="1" max="99" 
                 onchange="setQuantity('${item.product_id}', this.value)">
          <button class="quantity-btn" onclick="updateQuantity('${item.product_id}', 1)">
            <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
          </button>
        </div>
        <div class="item-actions">
          <button class="delete-btn" onclick="removeItem('${item.product_id}')">
            <svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
          </button>
        </div>
      </div>
    `;
  });

  html += `
    </div>
    <div class="cart-footer fade-in">
      <div class="cart-summary">
        <div class="summary-left">
          <div class="select-all">
            <input type="checkbox" id="selectAll" ${allChecked ? 'checked' : ''} onchange="toggleSelectAll()">
            <label for="selectAll">Select All</label>
          </div>
          <div class="summary-actions">
            <button onclick="batchDelete()">Delete Selected</button>
          </div>
        </div>
        <div class="summary-right">
          <div>
            Selected <span id="selectedCount">${cartItems.filter(item => item.checked).length}</span> items,
            Total: <span class="total-price">HK$${totalPrice.toFixed(2)}</span>
          </div>
          <button class="checkout-btn" onclick="checkout()">Checkout</button>
        </div>
      </div>
    </div>
  `;

  cartContainer.innerHTML = html;
}

/* ---------- Load Cart Data ---------- */
async function loadCart() {
  try {
    // Ensure there's a session ID
    let sessionId = localStorage.getItem('userID') || getCookie('cart_session');
    if (!sessionId) {
      sessionId = genAnon();
      localStorage.setItem('userID', sessionId);
      setCookie('cart_session', sessionId);
    }

    // Try to get cart data from API
    try {
      const res = await fetch(API_CART, {
        headers: { 'X-SessionID': sessionId }
      });
      
      if (res.ok) {
        const data = await res.json();
        cartItems = data.map(item => ({...item, checked: true}));
        isDemo = false;
        
        // If cart has items, get product details
        if (cartItems.length > 0) {
          await loadProductDetails();
        }
      } else {
        // If API request fails, use demo data
        console.log('Using demo data to display cart');
        cartItems = [...DEMO_PRODUCTS];
        isDemo = true;
      }
    } catch (error) {
      // If API request errors, use demo data
      console.log('API connection failed, using demo data', error);
      cartItems = [...DEMO_PRODUCTS];
      isDemo = true;
    }
    
    renderCart();
  } catch (error) {
    console.error('Failed to load cart:', error);
    renderEmptyCart();
  }
}

/* ---------- Load Product Details ---------- */
async function loadProductDetails() {
  if (isDemo) return; // No need to load product details in demo mode
  
  try {
    // Get all product data to supplement missing info in cart
    const res = await fetch(API_PRODUCTS);
    if (!res.ok) throw new Error(`HTTP error ${res.status}`);
    
    allProducts = await res.json();
    
    // Merge product details into cart items
    cartItems = cartItems.map(item => {
      const product = allProducts.find(p => p.product_id === item.product_id);
      return product ? {...item, ...product} : item;
    });
  } catch (error) {
    console.error('Failed to load product details:', error);
  }
}

/* ---------- Update Product Quantity ---------- */
async function updateQuantity(productId, change) {
  const item = cartItems.find(item => item.product_id === productId);
  if (!item) return;
  
  const newQuantity = Math.max(1, Math.min(99, item.quantity + change));
  if (newQuantity === item.quantity) return;
  
  if (!isDemo) {
    try {
      const sessionId = localStorage.getItem('userID') || getCookie('cart_session');
      
      const res = await fetch(`${API_CART}/${productId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'X-SessionID': sessionId
        },
        body: JSON.stringify({ quantity: newQuantity })
      });
      
      if (!res.ok) throw new Error(`HTTP error ${res.status}`);
    } catch (error) {
      console.error('Failed to update quantity:', error);
    }
  }
  
  // Update local data
  item.quantity = newQuantity;
  renderCart();
}

/* ---------- Set Product Quantity ---------- */
function setQuantity(productId, value) {
  const quantity = parseInt(value);
  if (isNaN(quantity) || quantity < 1) return;
  
  updateQuantity(productId, quantity - cartItems.find(item => item.product_id === productId).quantity);
}

/* ---------- Remove Item ---------- */
async function removeItem(productId) {
  if (!confirm('Are you sure you want to remove this item from your cart?')) return;
  
  if (!isDemo) {
    try {
      const sessionId = localStorage.getItem('userID') || getCookie('cart_session');
      
      const res = await fetch(`${API_CART}/${productId}`, {
        method: 'DELETE',
        headers: { 'X-SessionID': sessionId }
      });
      
      if (!res.ok) throw new Error(`HTTP error ${res.status}`);
    } catch (error) {
      console.error('Failed to delete item:', error);
    }
  }
  
  // Update local data
  cartItems = cartItems.filter(item => item.product_id !== productId);
  renderCart();
}

/* ---------- Toggle Item Selection ---------- */
function toggleItemCheck(productId) {
  const item = cartItems.find(item => item.product_id === productId);
  if (item) {
    item.checked = !item.checked;
    renderCart();
  }
}

/* ---------- Toggle Select All ---------- */
function toggleSelectAll() {
  const selectAll = document.getElementById('selectAll').checked;
  cartItems.forEach(item => item.checked = selectAll);
  renderCart();
}

/* ---------- Batch Delete ---------- */
async function batchDelete() {
  const selectedItems = cartItems.filter(item => item.checked);
  if (selectedItems.length === 0) {
    alert('Please select items to delete');
    return;
  }
  
  if (!confirm(`Are you sure you want to delete ${selectedItems.length} selected items?`)) return;
  
  if (!isDemo) {
    try {
      const sessionId = localStorage.getItem('userID') || getCookie('cart_session');
      const selectedIds = selectedItems.map(item => item.product_id);
      
      const res = await fetch(`${API_CART}/batch`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
          'X-SessionID': sessionId
        },
        body: JSON.stringify({ ids: selectedIds })
      });
      
      if (!res.ok) throw new Error(`HTTP error ${res.status}`);
    } catch (error) {
      console.error('Batch delete failed:', error);
    }
  }
  
  // Update local data
  cartItems = cartItems.filter(item => !item.checked);
  renderCart();
}

/* ---------- Checkout ---------- */
function checkout() {
  const selectedItems = cartItems.filter(item => item.checked);
  if (selectedItems.length === 0) {
    alert('Please select items to checkout');
    return;
  }
  
   // Save selected items to localStorage
   localStorage.setItem('checkoutItems', JSON.stringify(selectedItems));
  
   // Redirect to checkout page
   window.location.href = 'checkout.html';
}

/* ---------- Redirect Search ---------- */
function redirectToSearch() {
  const query = document.getElementById('searchInput').value.trim();
  if (query) {
    // Redirect to searchpage.html with search keyword as query parameter
    window.location.href = `searchpage.html?keyword=${encodeURIComponent(query)}`;
  } else {
    alert("Please enter a search term!");
  }
}

/* ---------- Initialize ---------- */
document.addEventListener('DOMContentLoaded', loadCart);
</script>
</body>
</html>

