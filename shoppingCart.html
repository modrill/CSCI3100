<!-- 
    Shopping Cart Template
    Main features:
    - Product display and cart functionality
    - Shopping cart interface
    - Add/remove products
    - Quantity adjustment
    - Total price calculation
-->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Buyzu Â· Shopping Cart</title>

<!-- ============ Styles ============ -->
<style>
  /* Reset */
  *, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
  body { font-family: Arial, sans-serif; background: #F7FFF7; color: #1A1F36; line-height:1.5; }
  a { color: inherit; text-decoration: none; }

  /* Utility */
  .container { width:90%; max-width:800px; margin:0 auto; padding:2rem 0; }
  .glass { background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); border-radius:12px; box-shadow:0 8px 32px rgba(0,0,0,0.1); }

  /* Header */
  header { position: sticky; top:0; background: rgba(255,255,255,0.8); backdrop-filter: blur(8px); z-index:100; }
  .nav-wrapper { 
    display: flex; 
    align-items: center; 
    justify-content: space-between; 
    padding: 1rem .5rem; 
  }
  .logo { font-size:1.5rem; font-weight:bold; color:#FF6B6B; }
  .auth-buttons { display:flex; gap:1rem; }
  .auth-buttons .btn { padding:.4rem .8rem; border-radius:20px; font-size:.9rem; cursor:pointer; transition:.25s; }
  .auth-buttons .login { background:transparent; border:1px solid #1A1F36; color:#1A1F36; }
  .auth-buttons .register { background:#FF6B6B; border:none; color:#fff; }
  .auth-buttons .btn:hover { opacity:.85; }

  /* Main area */
  main { max-width:800px; margin:0 auto; padding:2rem 0; }
  .section-head { display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:1.5rem; }
  .section-head h2 { font-size:1.5rem; font-weight:700; }
  .empty-cart { text-align:center; padding:3rem 1rem; color:#6B7280; background:white; border-radius:12px; box-shadow:0 8px 32px rgba(0,0,0,0.1); }
  .empty-cart svg { width:64px; height:64px; fill:#6B7280; margin-bottom:1rem; }

  /* Cart list */
  .cart-list { background:#fff; border-radius:12px; overflow:hidden; box-shadow:0 8px 32px rgba(0,0,0,0.1); }
  .cart-header { display:grid; grid-template-columns:24px 100px 1fr 120px 100px 80px; padding:1rem; font-weight:600; border-bottom:1px solid #E5E7EB; background:#F0F1F3; }
  .cart-item { display:grid; grid-template-columns:24px 100px 1fr 120px 100px 80px; padding:1rem; border-bottom:1px solid #E5E7EB; align-items:center; }
  .cart-item:last-child { border-bottom:none; }
  .cart-item:hover { background:#F7FFF7; }

  /* Product image and info */
  .item-check { display:flex; align-items:center; justify-content:center; }
  .item-check input { width:18px; height:18px; cursor:pointer; }
  .item-img { padding:.25rem; }
  .item-img img { width:100%; height:auto; border-radius:8px; object-fit:cover; aspect-ratio:1/1; }
  .item-info { padding:0 .5rem; }
  .item-name { font-weight:600; margin-bottom:.25rem; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
  .item-brand { color:#6B7280; font-size:.85rem; }

  /* Price and quantity */
  .item-price { font-weight:600; color:#FF6B6B; }
  .item-quantity { display:flex; align-items:center; }
  .quantity-btn { width:28px; height:28px; border:none; background:#F0F1F3; border-radius:4px; cursor:pointer; display:flex; align-items:center; justify-content:center; }
  .quantity-btn svg { width:16px; height:16px; fill:#1A1F36; }
  .quantity-input { width:40px; text-align:center; border:1px solid #E5E7EB; border-radius:4px; padding:.25rem; margin:0 .25rem; }
  .item-actions { display:flex; justify-content:center; }
  .delete-btn { background:none; border:none; cursor:pointer; }
  .delete-btn svg { width:20px; height:20px; fill:#6B7280; }
  .delete-btn:hover svg { fill:#FF6B6B; }

  /* Cart footer */
  .cart-footer { margin-top:1.5rem; }
  .cart-summary { background:#fff; border-radius:12px; padding:1rem; display:flex; justify-content:space-between; align-items:center; box-shadow:0 8px 32px rgba(0,0,0,0.1); }
  .summary-left { display:flex; align-items:center; gap:1.5rem; }
  .select-all { display:flex; align-items:center; gap:.5rem; }
  .select-all input { width:18px; height:18px; cursor:pointer; }
  .summary-actions button { background:none; border:none; color:#6B7280; cursor:pointer; }
  .summary-actions button:hover { color:#FF6B6B; }
  .summary-right { display:flex; align-items:center; gap:1.5rem; }
  .total-price { font-weight:700; color:#FF6B6B; }
  .checkout-btn { background:#FF6B6B; color:#fff; border:none; border-radius:8px; padding:.5rem 1.5rem; font-weight:600; cursor:pointer; }
  .checkout-btn:hover { opacity:.9; }

  /* Animations */
  @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
  .fade-in { animation: fadeIn .3s ease forwards; }
</style>

</head>
<body>

<!-- Header -->
<header>
  <div class="nav-wrapper container">
    <a href="homepage.html" class="logo">Buyzu</a>
    <div class="auth-buttons">
      <div id="user-welcome" style="color: #1A1F36;">Welcome, <span id="username"></span></div>
    </div>
  </div>
</header>

<!-- Main Content -->
<main class="container">
  <div class="section-head">
    <h2>Shopping Cart</h2>
  </div>
  
  <div id="cartContainer">
    <!-- Cart will be rendered here -->
    <div class="loading">Loading your cart...</div>
  </div>
</main>

<!-- Scripts -->
<script>
/* ---------- Constants ---------- */
const API_CART = '/api/cart';
const API_PRODUCTS = '/api/products';
const cartContainer = document.getElementById('cartContainer');

let cartItems = [];
let allProducts = [];

/* ---------- Cookie ---------- */
function getCookie(n){const m=document.cookie.match('(?:^|; )'+n+'=([^;]+)');return m?decodeURIComponent(m[1]):null;}
function setCookie(n,v,d=365){document.cookie=`${n}=${encodeURIComponent(v)}; expires=${new Date(Date.now()+d*864e5).toUTCString()}; path=/`;}
function genAnon(){return 'sess_'+Date.now().toString(36)+'_'+Math.random().toString(16).slice(2,6);}

/* ---------- Render Empty Cart ---------- */
function renderEmptyCart() {
  cartContainer.innerHTML = `
    <div class="empty-cart fade-in">
      <svg viewBox="0 0 24 24">
        <path d="M16.2 4H19c.6 0 1 .4 1 1v1H4V5c0-.6.4-1 1-1h2.8l.6-1.1C8.7 2.4 9.2 2 9.8 2h4.4c.6 0 1.1.4 1.4.9L16.2 4zM3 8h18v12c0 1.1-.9 2-2 2H5c-1.1 0-2-.9-2-2V8zm7 3v6c0 .6.4 1 1 1s1-.4 1-1v-6c0-.6-.4-1-1-1s-1 .4-1 1zm4 0v6c0 .6.4 1 1 1s1-.4 1-1v-6c0-.6-.4-1-1-1s-1 .4-1 1z"/>
      </svg>
      <p>Your cart is empty. Let's find some products!</p>
    </div>
  `;
}

/* ---------- Render Cart List ---------- */
function renderCart() {
  if (!cartItems || cartItems.length === 0) {
    renderEmptyCart();
    return;
  }

  // Calculate total price
  const totalPrice = cartItems.reduce((sum, item) => {
    return item.checked ? sum + (item.price * item.quantity) : sum;
  }, 0);

  // Check if all items are selected
  const allChecked = cartItems.length > 0 && cartItems.every(item => item.checked);
  
  // Build HTML
  let html = `
    <div class="cart-list fade-in">
      <div class="cart-header">
        <div class="item-check">Select</div>
        <div></div>
        <div>Product</div>
        <div>Price</div>
        <div>Quantity</div>
        <div>Action</div>
      </div>
  `;

  // Add each product
  cartItems.forEach(item => {
    html += `
      <div class="cart-item" data-id="${item.productID}">
        <div class="item-check">
          <input type="checkbox" ${item.checked ? 'checked' : ''} onchange="toggleItemCheck('${item.productID}')">
        </div>
        <div class="item-img">
          <img src="/images/${item.img}" alt="${item.productName}">
        </div>
        <div class="item-info">
          <div class="item-name">${item.productName}</div>
          <div class="item-brand">${item.brandName || ''}</div>
        </div>
        <div class="item-price">HK$${(+item.price).toFixed(2)}</div>
        <div class="item-quantity">
          <button class="quantity-btn" onclick="updateQuantity('${item.productID}', -1)">
            <svg viewBox="0 0 24 24"><path d="M5 13v-2h14v2z"/></svg>
          </button>
          <input type="number" class="quantity-input" value="${item.quantity}" min="1" max="99" 
                 onchange="setQuantity('${item.productID}', this.value)">
          <button class="quantity-btn" onclick="updateQuantity('${item.productID}', 1)">
            <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
          </button>
        </div>
        <div class="item-actions">
          <button class="delete-btn" onclick="removeItem('${item.productID}')">
            <svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
          </button>
        </div>
      </div>
    `;
  });

  html += `
    </div>
    <div class="cart-footer fade-in">
      <div class="cart-summary">
        <div class="summary-left">
          <div class="select-all">
            <input type="checkbox" id="selectAll" ${allChecked ? 'checked' : ''} onchange="toggleSelectAll()">
            <label for="selectAll">Select All</label>
          </div>
          <div class="summary-actions">
            <button onclick="batchDelete()">Delete Selected</button>
          </div>
        </div>
        <div class="summary-right">
          <div>
            Selected <span id="selectedCount">${cartItems.filter(item => item.checked).length}</span> items,
            Total: <span class="total-price">HK$${totalPrice.toFixed(2)}</span>
          </div>
          <button class="checkout-btn" onclick="checkout()">Checkout</button>
        </div>
      </div>
    </div>
  `;

  cartContainer.innerHTML = html;
}

/* ---------- Load Cart Data ---------- */
async function loadCart() {
  try {
    // Ensure session ID exists
    let sessionId = localStorage.getItem('userID') || getCookie('cart_session');
    if (!sessionId) {
      sessionId = genAnon();
      localStorage.setItem('userID', sessionId);
      setCookie('cart_session', sessionId);
    }

    // Get cart data from API
    try {
      const res = await fetch(API_CART, {
        headers: { 'X-SessionID': sessionId }
      });
      
      if (res.ok) {
        const data = await res.json();
        cartItems = data.map(item => ({...item, checked: true}));
        
        // If cart has items, get product details
        if (cartItems.length > 0) {
          await loadProductDetails();
        }
      } else {
        console.error('Failed to fetch cart data:', res.status);
        cartItems = []; // Empty cart if API request fails
      }
    } catch (error) {
      console.error('API connection failed:', error);
      cartItems = []; // Empty cart on error
    }
    
    renderCart();
  } catch (error) {
    console.error('Failed to load cart:', error);
    renderEmptyCart();
  }
}

/* ---------- Load Product Details ---------- */
async function loadProductDetails() {
  try {
    // Get all product data to supplement missing info in cart items
    const res = await fetch(API_PRODUCTS);
    if (!res.ok) throw new Error(`HTTP error ${res.status}`);
    
    allProducts = await res.json();
    
    // Merge product details into cart items
    cartItems = cartItems.map(item => {
      const product = allProducts.find(p => p.productID === item.productID);
      return product ? {...item, ...product} : item;
    });
  } catch (error) {
    console.error('Failed to load product details:', error);
  }
}

/* ---------- Add To Cart ---------- */
async function addToCart(productData) {
  try {
    const sessionId = localStorage.getItem('userID') || getCookie('cart_session');
    
    const response = await fetch(API_CART, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-SessionID': sessionId
      },
      body: JSON.stringify({
        productID: productData.productID,
        quantity: productData.quantity || 1
      })
    });
    
    if (response.ok) {
      // Reload cart after successful addition
      await loadCart();
      return true;
    } else {
      console.error('Failed to add item to cart:', response.status);
      return false;
    }
  } catch (error) {
    console.error('Error adding item to cart:', error);
    return false;
  }
}

/* ---------- Toggle Item Selection ---------- */
async function toggleItemCheck(productID) {
  const item = cartItems.find(item => item.productID === productID);
  if (item) {
    item.checked = !item.checked;
    renderCart();
  }
}

/* ---------- Toggle Select All ---------- */
function toggleSelectAll() {
  const selectAllChecked = document.getElementById('selectAll').checked;
  cartItems.forEach(item => item.checked = selectAllChecked);
  renderCart();
}

/* ---------- Update Item Quantity ---------- */
async function updateQuantity(productID, change) {
  const item = cartItems.find(item => item.productID === productID);
  if (!item) return;
  
  const newQuantity = Math.max(1, item.quantity + change);
  
  try {
    const sessionId = localStorage.getItem('userID') || getCookie('cart_session');
    
    const response = await fetch(`${API_CART}/${productID}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'X-SessionID': sessionId
      },
      body: JSON.stringify({ quantity: newQuantity })
    });
    
    if (response.ok) {
      item.quantity = newQuantity;
      renderCart();
    } else {
      console.error('Failed to update quantity:', response.status);
    }
  } catch (error) {
    console.error('Error updating quantity:', error);
  }
}

/* ---------- Set Item Quantity ---------- */
async function setQuantity(productID, quantity) {
  const newQuantity = Math.max(1, Math.min(99, parseInt(quantity) || 1));
  await updateQuantity(productID, newQuantity - (cartItems.find(item => item.productID === productID)?.quantity || 0));
}

/* ---------- Remove Item from Cart ---------- */
async function removeItem(productID) {
  try {
    const sessionId = localStorage.getItem('userID') || getCookie('cart_session');
    
    const response = await fetch(`${API_CART}/${productID}`, {
      method: 'DELETE',
      headers: { 'X-SessionID': sessionId }
    });
    
    if (response.ok) {
      cartItems = cartItems.filter(item => item.productID !== productID);
      renderCart();
    } else {
      console.error('Failed to remove item:', response.status);
    }
  } catch (error) {
    console.error('Error removing item:', error);
  }
}

/* ---------- Batch Delete Selected Items ---------- */
async function batchDelete() {
  const selectedItems = cartItems.filter(item => item.checked);
  if (selectedItems.length === 0) return;
  
  if (!confirm(`Delete ${selectedItems.length} selected items?`)) return;
  
  try {
    const sessionId = localStorage.getItem('userID') || getCookie('cart_session');
    const deletePromises = selectedItems.map(item => 
      fetch(`${API_CART}/${item.productID}`, {
        method: 'DELETE',
        headers: { 'X-SessionID': sessionId }
      })
    );
    
    await Promise.all(deletePromises);
    cartItems = cartItems.filter(item => !item.checked);
    renderCart();
  } catch (error) {
    console.error('Error batch deleting items:', error);
  }
}

/* ---------- Checkout ---------- */
function checkout() {
    const selectedItems = cartItems.filter(item => item.checked);
    if (selectedItems.length === 0) {
      alert('Please select items to checkout first');
      return;
    }
    
     // Save selected items to localStorage
     localStorage.setItem('checkoutItems', JSON.stringify(selectedItems));
    
     // Redirect to checkout page
     window.location.href = 'checkout.html';
  }

/* ---------- Check Login Status ---------- */
function checkLoginStatus() {
  const userStr = localStorage.getItem('user');
  if (!userStr) {
    // If not logged in, redirect to login page
    window.location.href = 'login/frontend.html?redirect_url=' + encodeURIComponent(window.location.href);
    return;
  }
  
  // Display username
  const user = JSON.parse(userStr);
  document.getElementById('username').textContent = user.username;
}

/* ---------- Initialize ---------- */
document.addEventListener('DOMContentLoaded', () => {
  checkLoginStatus();
  loadCart();
});

// Expose addToCart to global scope for product page
window.addToCart = addToCart;
</script>

</body>
</html>