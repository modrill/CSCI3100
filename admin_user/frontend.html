<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>用户管理系统</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.2.3/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Microsoft YaHei', sans-serif;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .card-header {
            background-color: #4a69bd;
            color: white;
            border-radius: 10px 10px 0 0 !important;
            padding: 15px 20px;
            font-weight: bold;
        }
        .search-box {
            position: relative;
            margin-bottom: 20px;
        }
        .search-box .form-control {
            padding-left: 40px;
            border-radius: 20px;
        }
        .search-box .search-icon {
            position: absolute;
            left: 15px;
            top: 10px;
            color: #6c757d;
        }
        .table th {
            background-color: #f1f2f6;
        }
        .action-btn {
            margin-right: 5px;
        }
        .pagination {
            justify-content: center;
        }
        .modal-header {
            background-color: #4a69bd;
            color: white;
        }
        .modal-footer {
            border-top: none;
            padding: 15px 20px;
        }
        .badge-admin {
            background-color: #e74c3c;
            color: white;
        }
        .badge-user {
            background-color: #2ecc71;
            color: white;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            visibility: hidden;
        }
        .loading-spinner {
            width: 3rem;
            height: 3rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h2><i class="fas fa-users me-2"></i>用户管理系统</h2>
                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addUserModal">
                    <i class="fas fa-user-plus me-1"></i> 添加用户
                </button>
            </div>
            <div class="card-body">
                <div class="search-box">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="form-control" id="searchInput" placeholder="搜索用户名或邮箱...">
                </div>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>用户名</th>
                                <th>邮箱</th>
                                <th>创建时间</th>
                                <th>角色</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="userTableBody">
                            <!-- 用户数据将通过JavaScript动态加载 -->
                        </tbody>
                    </table>
                </div>
                <nav>
                    <ul class="pagination" id="pagination">
                        <!-- 分页链接将通过JavaScript动态加载 -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- 添加用户模态框 -->
    <div class="modal fade" id="addUserModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-user-plus me-2"></i>添加新用户</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addUserForm">
                        <div class="mb-3">
                            <label for="username" class="form-label">用户名</label>
                            <input type="text" class="form-control" id="username" required>
                        </div>
                        <div class="mb-3">
                            <label for="email" class="form-label">邮箱</label>
                            <input type="email" class="form-control" id="email" required>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">密码</label>
                            <input type="password" class="form-control" id="password" required>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="isAdmin">
                            <label class="form-check-label" for="isAdmin">
                                管理员权限
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="submitAddUser">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 编辑用户模态框 -->
    <div class="modal fade" id="editUserModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-user-edit me-2"></i>编辑用户</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editUserForm">
                        <input type="hidden" id="editUserId">
                        <div class="mb-3">
                            <label for="editUsername" class="form-label">用户名</label>
                            <input type="text" class="form-control" id="editUsername" required>
                        </div>
                        <div class="mb-3">
                            <label for="editEmail" class="form-label">邮箱</label>
                            <input type="email" class="form-control" id="editEmail" required>
                        </div>
                        <div class="mb-3">
                            <label for="editPassword" class="form-label">密码 (留空则不修改)</label>
                            <input type="password" class="form-control" id="editPassword">
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="editIsAdmin">
                            <label class="form-check-label" for="editIsAdmin">
                                管理员权限
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="submitEditUser">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 删除确认模态框 -->
    <div class="modal fade" id="deleteUserModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-exclamation-triangle me-2"></i>删除用户</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>您确定要删除此用户吗？此操作不可撤销。</p>
                    <p><strong>用户名: <span id="deleteUsername"></span></strong></p>
                    <input type="hidden" id="deleteUserId">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-danger" id="confirmDelete">删除</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 加载动画 -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner-border loading-spinner text-primary" role="status">
            <span class="visually-hidden">加载中...</span>
        </div>
    </div>

    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.2.3/js/bootstrap.bundle.min.js"></script>
    <script>
        // 配置
        const API_BASE_URL = 'http://localhost:5002/api/admin';
        const ADMIN_TOKEN = 'admin-token'; // 简单模拟，实际应使用更安全的认证方式
        let currentPage = 1;
        let totalPages = 1;
        let users = [];

        // 显示加载动画
        function showLoading() {
            document.getElementById('loadingOverlay').style.visibility = 'visible';
        }

        // 隐藏加载动画
        function hideLoading() {
            document.getElementById('loadingOverlay').style.visibility = 'hidden';
        }

        // 显示错误提示
        function showError(message) {
            alert(message);
        }

        // 格式化日期时间
        function formatDateTime(dateTimeStr) {
            if (!dateTimeStr) return '-';
            const date = new Date(dateTimeStr);
            return date.toLocaleString('zh-CN');
        }

        // 加载用户列表
        function loadUsers(page = 1) {
            showLoading();
            currentPage = page;
            
            $.ajax({
                url: `${API_BASE_URL}/users?page=${page}`,
                method: 'GET',
                headers: {
                    'Authorization': ADMIN_TOKEN
                },
                success: function(response) {
                    users = response.users;
                    totalPages = response.total_pages;
                    
                    // 渲染用户表格
                    renderUserTable(users);
                    
                    // 渲染分页
                    renderPagination(currentPage, totalPages);
                    
                    hideLoading();
                },
                error: function(xhr) {
                    hideLoading();
                    const errorMsg = xhr.responseJSON ? xhr.responseJSON.error : '加载用户列表失败';
                    showError(errorMsg);
                }
            });
        }

        // 渲染用户表格
        function renderUserTable(users) {
            const tableBody = $('#userTableBody');
            tableBody.empty();
            
            if (users.length === 0) {
                tableBody.append('<tr><td colspan="6" class="text-center">没有找到用户</td></tr>');
                return;
            }
            
            users.forEach(user => {
                const roleClass = user.is_admin ? 'badge-admin' : 'badge-user';
                const roleName = user.is_admin ? '管理员' : '普通用户';
                
                const row = `
                    <tr>
                        <td>${user.id}</td>
                        <td>${user.username}</td>
                        <td>${user.email}</td>
                        <td>${formatDateTime(user.created_at)}</td>
                        <td><span class="badge ${roleClass}">${roleName}</span></td>
                        <td>
                            <button class="btn btn-sm btn-primary action-btn edit-user" data-id="${user.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger action-btn delete-user" data-id="${user.id}" data-username="${user.username}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
                
                tableBody.append(row);
            });
            
            // 绑定编辑和删除按钮事件
            $('.edit-user').click(function() {
                const userId = $(this).data('id');
                openEditUserModal(userId);
            });
            
            $('.delete-user').click(function() {
                const userId = $(this).data('id');
                const username = $(this).data('username');
                openDeleteUserModal(userId, username);
            });
        }

        // 渲染分页
        function renderPagination(currentPage, totalPages) {
            const pagination = $('#pagination');
            pagination.empty();
            
            if (totalPages <= 1) return;
            
            // 上一页按钮
            const prevButton = `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" data-page="${currentPage - 1}" aria-label="上一页">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
            `;
            pagination.append(prevButton);
            
            // 页码按钮
            for (let i = 1; i <= totalPages; i++) {
                const pageButton = `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" data-page="${i}">${i}</a>
                    </li>
                `;
                pagination.append(pageButton);
            }
            
            // 下一页按钮
            const nextButton = `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" data-page="${currentPage + 1}" aria-label="下一页">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
            `;
            pagination.append(nextButton);
            
            // 绑定分页点击事件
            $('.page-link').click(function(e) {
                e.preventDefault();
                const page = $(this).data('page');
                if (page >= 1 && page <= totalPages) {
                    loadUsers(page);
                }
            });
        }

        // 打开编辑用户模态框
        function openEditUserModal(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            $('#editUserId').val(user.id);
            $('#editUsername').val(user.username);
            $('#editEmail').val(user.email);
            $('#editPassword').val(''); // 不显示原密码
            $('#editIsAdmin').prop('checked', user.is_admin);
            
            $('#editUserModal').modal('show');
        }

        // 打开删除用户确认模态框
        function openDeleteUserModal(userId, username) {
            $('#deleteUserId').val(userId);
            $('#deleteUsername').text(username);
            $('#deleteUserModal').modal('show');
        }

        // 搜索用户
        function searchUsers(keyword) {
            showLoading();
            
            $.ajax({
                url: `${API_BASE_URL}/search-users?keyword=${encodeURIComponent(keyword)}`,
                method: 'GET',
                headers: {
                    'Authorization': ADMIN_TOKEN
                },
                success: function(response) {
                    users = response.users;
                    
                    // 渲染用户表格
                    renderUserTable(users);
                    
                    // 隐藏分页（搜索结果不分页）
                    $('#pagination').empty();
                    
                    hideLoading();
                },
                error: function(xhr) {
                    hideLoading();
                    const errorMsg = xhr.responseJSON ? xhr.responseJSON.error : '搜索用户失败';
                    showError(errorMsg);
                }
            });
        }

        // 添加用户
        function addUser(userData) {
            showLoading();
            
            $.ajax({
                url: `${API_BASE_URL}/users`,
                method: 'POST',
                headers: {
                    'Authorization': ADMIN_TOKEN,
                    'Content-Type': 'application/json'
                },
                data: JSON.stringify(userData),
                success: function(response) {
                    hideLoading();
                    $('#addUserModal').modal('hide');
                    loadUsers(currentPage);
                    $('#addUserForm')[0].reset();
                },
                error: function(xhr) {
                    hideLoading();
                    const errorMsg = xhr.responseJSON ? xhr.responseJSON.error : '添加用户失败';
                    showError(errorMsg);
                }
            });
        }

        // 更新用户
        function updateUser(userId, userData) {
            showLoading();
            
            $.ajax({
                url: `${API_BASE_URL}/users/${userId}`,
                method: 'PUT',
                headers: {
                    'Authorization': ADMIN_TOKEN,
                    'Content-Type': 'application/json'
                },
                data: JSON.stringify(userData),
                success: function(response) {
                    hideLoading();
                    $('#editUserModal').modal('hide');
                    loadUsers(currentPage);
                },
                error: function(xhr) {
                    hideLoading();
                    const errorMsg = xhr.responseJSON ? xhr.responseJSON.error : '更新用户失败';
                    showError(errorMsg);
                }
            });
        }

        // 删除用户
        function deleteUser(userId) {
            showLoading();
            
            $.ajax({
                url: `${API_BASE_URL}/users/${userId}`,
                method: 'DELETE',
                headers: {
                    'Authorization': ADMIN_TOKEN
                },
                success: function(response) {
                    hideLoading();
                    $('#deleteUserModal').modal('hide');
                    loadUsers(currentPage);
                },
                error: function(xhr) {
                    hideLoading();
                    const errorMsg = xhr.responseJSON ? xhr.responseJSON.error : '删除用户失败';
                    showError(errorMsg);
                }
            });
        }

        // 页面加载完成后执行
        $(document).ready(function() {
            // 初始加载用户列表
            loadUsers();
            
            // 搜索框输入事件
            let searchTimeout;
            $('#searchInput').on('input', function() {
                clearTimeout(searchTimeout);
                const keyword = $(this).val().trim();
                
                if (keyword.length === 0) {
                    loadUsers(1);
                    return;
                }
                
                searchTimeout = setTimeout(function() {
                    searchUsers(keyword);
                }, 500);
            });
            
            // 添加用户表单提交
            $('#submitAddUser').click(function() {
                const username = $('#username').val().trim();
                const email = $('#email').val().trim();
                const password = $('#password').val();
                const isAdmin = $('#isAdmin').is(':checked');
                
                if (!username || !email || !password) {
                    showError('请填写所有必填字段');
                    return;
                }
                
                const userData = {
                    username: username,
                    email: email,
                    password: password,
                    is_admin: isAdmin
                };
                
                addUser(userData);
            });
            
            // 编辑用户表单提交
            $('#submitEditUser').click(function() {
                const userId = $('#editUserId').val();
                const username = $('#editUsername').val().trim();
                const email = $('#editEmail').val().trim();
                const password = $('#editPassword').val();
                const isAdmin = $('#editIsAdmin').is(':checked');
                
                if (!username || !email) {
                    showError('请填写用户名和邮箱');
                    return;
                }
                
                const userData = {
                    username: username,
                    email: email,
                    is_admin: isAdmin
                };
                
                // 只有当密码不为空时才包含密码字段
                if (password) {
                    userData.password = password;
                }
                
                updateUser(userId, userData);
            });
            
            // 删除用户确认
            $('#confirmDelete').click(function() {
                const userId = $('#deleteUserId').val();
                deleteUser(userId);
            });
        });
    </script>
</body>
</html> 