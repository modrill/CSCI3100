<!-- 
    购物车模板
    大致功能模板：一个temple;
    商品的展示和加入购物车（无数据捏
    购物车界面
    加减商品数
    删除
    计算总价
-->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>BuyZu · 购物车</title>

<!-- ============ 样式 ============ -->
<style>
:root{
  --bg:#f6f7f9;--card-bg:#fff;--border:#e5e7eb;--primary:#2563eb;
  --text:#111827;--muted:#6b7280;--radius:18px;          /* 圆角更大 */
  --shadow:0 4px 12px rgba(0,0,0,.06);--transition:.55s;--skeleton:#e0e0e0;
  --danger:#dc2626;--success:#10b981;
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;
     background:var(--bg);color:var(--text);line-height:1.5}

/* 顶栏 */
header{display:flex;align-items:center;gap:.6rem;background:var(--card-bg);
       border-bottom:1px solid var(--border);padding:.8rem 1rem;font-weight:600;font-size:1.15rem}
header svg{width:28px;height:28px;fill:var(--primary)}

/* 主区域 */
main{max-width:960px;margin:1.2rem auto;padding:0 1rem}
.section-head{display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:.8rem}
.section-head h2{font-size:1.05rem;font-weight:700}
.empty-cart{text-align:center;padding:3rem 1rem;color:var(--muted)}
.empty-cart svg{width:64px;height:64px;fill:var(--muted);margin-bottom:1rem}

/* 购物车列表 */
.cart-list{background:var(--card-bg);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow)}
.cart-header{display:grid;grid-template-columns:24px 100px 1fr 120px 100px 80px;padding:1rem;font-weight:600;border-bottom:1px solid var(--border);background:#fafafa}
.cart-item{display:grid;grid-template-columns:24px 100px 1fr 120px 100px 80px;padding:1rem;border-bottom:1px solid var(--border);align-items:center}
.cart-item:last-child{border-bottom:none}
.cart-item:hover{background:#f9fafb}

/* 商品图片和信息 */
.item-check{display:flex;align-items:center;justify-content:center}
.item-check input{width:18px;height:18px;cursor:pointer}
.item-img{padding:.25rem}
.item-img img{width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:8px;background:#fafafa}
.item-info{padding:0 .5rem}
.item-name{font-weight:600;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.item-brand{font-size:.85rem;color:var(--muted);margin-top:.25rem}

/* 数量调整 */
.item-quantity{display:flex;align-items:center;border:1px solid var(--border);border-radius:8px;overflow:hidden}
.quantity-btn{width:32px;height:32px;display:flex;align-items:center;justify-content:center;background:none;border:none;cursor:pointer}
.quantity-btn:hover{background:#f0f1f3}
.quantity-btn svg{width:16px;height:16px;fill:var(--muted)}
.quantity-input{width:40px;height:32px;border:none;text-align:center;font-size:.9rem}
.quantity-input:focus{outline:none}

/* 价格和操作 */
.item-price{font-weight:600;color:#d9230f}
.item-actions{display:flex;justify-content:center}
.delete-btn{background:none;border:none;cursor:pointer;color:var(--muted);display:flex;align-items:center;justify-content:center;padding:.5rem}
.delete-btn:hover{color:var(--danger)}
.delete-btn svg{width:18px;height:18px;fill:currentColor}

/* 结算区域 */
.cart-footer{margin-top:1.5rem;background:var(--card-bg);border:1px solid var(--border);border-radius:var(--radius);padding:1.2rem;box-shadow:var(--shadow)}
.cart-summary{display:flex;justify-content:space-between;align-items:center}
.summary-left{display:flex;align-items:center;gap:.75rem}
.select-all{display:flex;align-items:center;gap:.5rem}
.select-all input{width:18px;height:18px;cursor:pointer}
.summary-actions{display:flex;gap:.5rem}
.summary-actions button{background:none;border:none;color:var(--muted);cursor:pointer;font-size:.9rem}
.summary-actions button:hover{color:var(--primary)}
.summary-right{display:flex;align-items:center;gap:1.5rem}
.total-price{font-size:1.1rem;font-weight:700;color:#d9230f}
.checkout-btn{background:var(--primary);color:#fff;border:none;border-radius:8px;padding:.75rem 1.5rem;font-weight:600;cursor:pointer;transition:background .25s}
.checkout-btn:hover{background:#1d4ed8}

/* 进入动画 */
@keyframes fadeIn{
  0%{opacity:0;transform:translateY(10px)}
  100%{opacity:1;transform:none}
}
.fade-in{animation:fadeIn .35s ease-out both}

/* 响应式调整 */
@media(max-width:768px){
  .cart-header{display:none}
  .cart-item{grid-template-columns:24px 80px 1fr;grid-template-areas:
    "check img info"
    "check img price"
    "check img quantity"
    "check img actions";
    gap:.5rem;
  }
  .item-check{grid-area:check}
  .item-img{grid-area:img}
  .item-info{grid-area:info}
  .item-price{grid-area:price}
  .item-quantity{grid-area:quantity;width:120px}
  .item-actions{grid-area:actions;justify-content:flex-start}
  
  .cart-summary{flex-direction:column;align-items:flex-start;gap:1rem}
  .summary-right{width:100%;justify-content:space-between}
}
</style>
</head>

<body>
<header>
  <svg viewBox="0 0 24 24"><path d="M7 4h-2l-3 7v2h2l2-4h11l1.2 3H20v2h-2l-1-3H8l-1 2H3v-2l3-7zM6 18a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm10 0a2 2 0 1 0 .001 3.999A2 2 0 0 0 16 18z"/></svg>
  BuyZu 购物车
</header>

<main>
  <section>
    <div class="section-head">
      <h2>我的购物车</h2>
    </div>

    <div id="cartContainer">
      <!-- 购物车内容将通过JS动态加载 -->
    </div>
  </section>
</main>

<!-- ============ 脚本 ============ -->
<script>
/* ---------- 常量 ---------- */
const API_CART = '/api/cart';
const API_PRODUCTS = '/api/products';
const cartContainer = document.getElementById('cartContainer');

// 示例商品数据
const DEMO_PRODUCTS = [
  {
    product_id: '1',
    name: 'Apple AirPods Pro (2nd Generation)',
    brandName: 'Apple',
    price: 1899.00,
    quantity: 1,
    img: 'p1.jpeg',
    checked: true
  },
  {
    product_id: '6',
    name: 'Sony WF-1000XM5 真无线降噪耳机',
    brandName: 'Sony',
    price: 1599.00,
    quantity: 2,
    img: 'p6.jpeg',
    checked: true
  },
  {
    product_id: '21',
    name: 'HUAWEI FreeClip 开放式无线耳机',
    brandName: 'HUAWEI',
    price: 1199.00,
    quantity: 1,
    img: 'p21.jpeg',
    checked: false
  }
];

let cartItems = [];
let allProducts = [];
let isDemo = true; // 标记是否使用演示数据

/* ---------- Cookie ---------- */
function getCookie(n){const m=document.cookie.match('(?:^|; )'+n+'=([^;]+)');return m?decodeURIComponent(m[1]):null;}
function setCookie(n,v,d=365){document.cookie=`${n}=${encodeURIComponent(v)}; expires=${new Date(Date.now()+d*864e5).toUTCString()}; path=/`;} 
function genAnon(){return 'sess_'+Date.now().toString(36)+'_'+Math.random().toString(16).slice(2,6);}

/* ---------- 渲染购物车为空 ---------- */
function renderEmptyCart() {
  cartContainer.innerHTML = `
    <div class="empty-cart fade-in">
      <svg viewBox="0 0 24 24">
        <path d="M16.2 4H19c.6 0 1 .4 1 1v1H4V5c0-.6.4-1 1-1h2.8l.6-1.1C8.7 2.4 9.2 2 9.8 2h4.4c.6 0 1.1.4 1.4.9L16.2 4zM3 8h18v12c0 1.1-.9 2-2 2H5c-1.1 0-2-.9-2-2V8zm7 3v6c0 .6.4 1 1 1s1-.4 1-1v-6c0-.6-.4-1-1-1s-1 .4-1 1zm4 0v6c0 .6.4 1 1 1s1-.4 1-1v-6c0-.6-.4-1-1-1s-1 .4-1 1z"/>
      </svg>
      <p>购物车还是空的，去挑选一些商品吧！</p>
    </div>
  `;
}

/* ---------- 渲染购物车列表 ---------- */
function renderCart() {
  if (!cartItems || cartItems.length === 0) {
    renderEmptyCart();
    return;
  }

  // 计算总价
  const totalPrice = cartItems.reduce((sum, item) => {
    return item.checked ? sum + (item.price * item.quantity) : sum;
  }, 0);

  // 检查是否全选
  const allChecked = cartItems.length > 0 && cartItems.every(item => item.checked);
  
  // 构建HTML
  let html = `
    <div class="cart-list fade-in">
      <div class="cart-header">
        <div class="item-check">选择</div>
        <div></div>
        <div>商品信息</div>
        <div>单价</div>
        <div>数量</div>
        <div>操作</div>
      </div>
  `;

  // 添加每个商品
  cartItems.forEach(item => {
    html += `
      <div class="cart-item" data-id="${item.product_id}">
        <div class="item-check">
          <input type="checkbox" ${item.checked ? 'checked' : ''} onchange="toggleItemCheck('${item.product_id}')">
        </div>
        <div class="item-img">
          <img src="${isDemo ? `https://picsum.photos/id/${item.product_id*10}/200` : `/images/${item.img || 'default.jpg'}`}" alt="${item.name}">
        </div>
        <div class="item-info">
          <div class="item-name">${item.name}</div>
          <div class="item-brand">${item.brandName || ''}</div>
        </div>
        <div class="item-price">￥${(+item.price).toFixed(2)}</div>
        <div class="item-quantity">
          <button class="quantity-btn" onclick="updateQuantity('${item.product_id}', -1)">
            <svg viewBox="0 0 24 24"><path d="M5 13v-2h14v2z"/></svg>
          </button>
          <input type="number" class="quantity-input" value="${item.quantity}" min="1" max="99" 
                 onchange="setQuantity('${item.product_id}', this.value)">
          <button class="quantity-btn" onclick="updateQuantity('${item.product_id}', 1)">
            <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
          </button>
        </div>
        <div class="item-actions">
          <button class="delete-btn" onclick="removeItem('${item.product_id}')">
            <svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
          </button>
        </div>
      </div>
    `;
  });

  html += `
    </div>
    <div class="cart-footer fade-in">
      <div class="cart-summary">
        <div class="summary-left">
          <div class="select-all">
            <input type="checkbox" id="selectAll" ${allChecked ? 'checked' : ''} onchange="toggleSelectAll()">
            <label for="selectAll">全选</label>
          </div>
          <div class="summary-actions">
            <button onclick="batchDelete()">删除选中</button>
          </div>
        </div>
        <div class="summary-right">
          <div>
            已选 <span id="selectedCount">${cartItems.filter(item => item.checked).length}</span> 件商品，
            合计：<span class="total-price">￥${totalPrice.toFixed(2)}</span>
          </div>
          <button class="checkout-btn" onclick="checkout()">去结算</button>
        </div>
      </div>
    </div>
  `;

  cartContainer.innerHTML = html;
}

/* ---------- 加载购物车数据 ---------- */
async function loadCart() {
  try {
    // 确保有会话ID
    let sessionId = localStorage.getItem('userID') || getCookie('cart_session');
    if (!sessionId) {
      sessionId = genAnon();
      localStorage.setItem('userID', sessionId);
      setCookie('cart_session', sessionId);
    }

    // 尝试从API获取购物车数据
    try {
      const res = await fetch(API_CART, {
        headers: { 'X-SessionID': sessionId }
      });
      
      if (res.ok) {
        const data = await res.json();
        cartItems = data.map(item => ({...item, checked: true}));
        isDemo = false;
        
        // 如果购物车有商品，获取商品详情
        if (cartItems.length > 0) {
          await loadProductDetails();
        }
      } else {
        // 如果API请求失败，使用演示数据
        console.log('使用演示数据展示购物车');
        cartItems = [...DEMO_PRODUCTS];
        isDemo = true;
      }
    } catch (error) {
      // 如果API请求出错，使用演示数据
      console.log('API连接失败，使用演示数据', error);
      cartItems = [...DEMO_PRODUCTS];
      isDemo = true;
    }
    
    renderCart();
  } catch (error) {
    console.error('加载购物车失败:', error);
    renderEmptyCart();
  }
}

/* ---------- 加载商品详情 ---------- */
async function loadProductDetails() {
  if (isDemo) return; // 演示模式不需要加载商品详情
  
  try {
    // 获取所有商品数据以补充购物车中缺少的信息
    const res = await fetch(API_PRODUCTS);
    if (!res.ok) throw new Error(`HTTP error ${res.status}`);
    
    allProducts = await res.json();
    
    // 将商品详情合并到购物车项中
    cartItems = cartItems.map(item => {
      const product = allProducts.find(p => p.product_id === item.product_id);
      return product ? {...item, ...product} : item;
    });
  } catch (error) {
    console.error('加载商品详情失败:', error);
  }
}

/* ---------- 更新商品数量 ---------- */
async function updateQuantity(productId, change) {
  const item = cartItems.find(item => item.product_id === productId);
  if (!item) return;
  
  const newQuantity = Math.max(1, Math.min(99, item.quantity + change));
  if (newQuantity === item.quantity) return;
  
  if (!isDemo) {
    try {
      const sessionId = localStorage.getItem('userID') || getCookie('cart_session');
      
      const res = await fetch(`${API_CART}/${productId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'X-SessionID': sessionId
        },
        body: JSON.stringify({ quantity: newQuantity })
      });
      
      if (!res.ok) throw new Error(`HTTP error ${res.status}`);
    } catch (error) {
      console.error('更新数量失败:', error);
    }
  }
  
  // 更新本地数据
  item.quantity = newQuantity;
  renderCart();
}

/* ---------- 设置商品数量 ---------- */
function setQuantity(productId, value) {
  const quantity = parseInt(value);
  if (isNaN(quantity) || quantity < 1) return;
  
  updateQuantity(productId, quantity - cartItems.find(item => item.product_id === productId).quantity);
}

/* ---------- 移除商品 ---------- */
async function removeItem(productId) {
  if (!confirm('确定要从购物车中删除此商品吗？')) return;
  
  if (!isDemo) {
    try {
      const sessionId = localStorage.getItem('userID') || getCookie('cart_session');
      
      const res = await fetch(`${API_CART}/${productId}`, {
        method: 'DELETE',
        headers: { 'X-SessionID': sessionId }
      });
      
      if (!res.ok) throw new Error(`HTTP error ${res.status}`);
    } catch (error) {
      console.error('删除商品失败:', error);
    }
  }
  
  // 更新本地数据
  cartItems = cartItems.filter(item => item.product_id !== productId);
  renderCart();
}

/* ---------- 切换商品选中状态 ---------- */
function toggleItemCheck(productId) {
  const item = cartItems.find(item => item.product_id === productId);
  if (item) {
    item.checked = !item.checked;
    renderCart();
  }
}

/* ---------- 切换全选状态 ---------- */
function toggleSelectAll() {
  const selectAll = document.getElementById('selectAll').checked;
  cartItems.forEach(item => item.checked = selectAll);
  renderCart();
}

/* ---------- 批量删除 ---------- */
async function batchDelete() {
  const selectedItems = cartItems.filter(item => item.checked);
  if (selectedItems.length === 0) {
    alert('请先选择要删除的商品');
    return;
  }
  
  if (!confirm(`确定要删除选中的 ${selectedItems.length} 件商品吗？`)) return;
  
  if (!isDemo) {
    try {
      const sessionId = localStorage.getItem('userID') || getCookie('cart_session');
      const selectedIds = selectedItems.map(item => item.product_id);
      
      const res = await fetch(`${API_CART}/batch`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
          'X-SessionID': sessionId
        },
        body: JSON.stringify({ ids: selectedIds })
      });
      
      if (!res.ok) throw new Error(`HTTP error ${res.status}`);
    } catch (error) {
      console.error('批量删除失败:', error);
    }
  }
  
  // 更新本地数据
  cartItems = cartItems.filter(item => !item.checked);
  renderCart();
}

/* ---------- 结算 ---------- */
function checkout() {
  const selectedItems = cartItems.filter(item => item.checked);
  if (selectedItems.length === 0) {
    alert('请先选择要结算的商品');
    return;
  }
  
  if (isDemo) {
    alert('演示模式：这里将跳转到结算页面');
    return;
  }
  
  // 这里应该跳转到结算页面
  window.location.href = '/checkout?items=' + selectedItems.map(item => item.product_id).join(',');
}

/* ---------- 初始化 ---------- */
document.addEventListener('DOMContentLoaded', loadCart);
</script>
</body>
</html>
