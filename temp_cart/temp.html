<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>BuyZu · 商品列表</title>

<!-- ============ 样式 ============ -->
<style>
:root{
  --bg:#f6f7f9;--card-bg:#fff;--border:#e5e7eb;--primary:#2563eb;
  --text:#111827;--muted:#6b7280;--radius:18px;
  --shadow:0 4px 12px rgba(0,0,0,.06);--transition:.55s;--skeleton:#e0e0e0;
  --danger:#dc2626;--success:#10b981;
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;
     background:var(--bg);color:var(--text);line-height:1.5}

/* 顶栏 */
header{display:flex;align-items:center;justify-content:space-between;background:var(--card-bg);
       border-bottom:1px solid var(--border);padding:.8rem 1rem;font-weight:600;font-size:1.15rem}
header .logo{display:flex;align-items:center;gap:.6rem;}
header svg{width:28px;height:28px;fill:var(--primary)}
header .cart-icon{position:relative;cursor:pointer;}
header .cart-icon svg{width:24px;height:24px;fill:var(--text)}
header .cart-count{position:absolute;top:-5px;right:-5px;background:var(--primary);color:#fff;
                  font-size:11px;width:18px;height:18px;border-radius:50%;
                  display:flex;align-items:center;justify-content:center;}

/* 主区域 */
main{max-width:1200px;margin:1.2rem auto;padding:0 1rem}
.section-head{display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:1.2rem}
.section-head h2{font-size:1.5rem;font-weight:700}

/* 商品列表 */
.product-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:1.5rem}
.product-card{background:var(--card-bg);border-radius:var(--radius);overflow:hidden;
             box-shadow:var(--shadow);transition:transform var(--transition)}
.product-card:hover{transform:translateY(-5px)}
.product-img{position:relative;padding-top:100%;overflow:hidden}
.product-img img{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;transition:transform .5s}
.product-card:hover .product-img img{transform:scale(1.05)}
.product-info{padding:1rem}
.product-brand{font-size:.85rem;color:var(--muted);margin-bottom:.25rem}
.product-name{font-weight:600;margin-bottom:.5rem;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.product-price{font-weight:700;color:#d9230f;font-size:1.1rem;margin-bottom:.75rem}
.add-to-cart{width:100%;background:var(--primary);color:#fff;border:none;border-radius:8px;
            padding:.6rem 0;font-weight:600;cursor:pointer;transition:background .25s}
.add-to-cart:hover{background:#1d4ed8}
.add-to-cart.added{background:var(--success)}

/* 进入动画 */
@keyframes fadeIn{
  0%{opacity:0;transform:translateY(10px)}
  100%{opacity:1;transform:none}
}
.fade-in{animation:fadeIn .35s ease-out both}
.fade-in-delay{animation:fadeIn .35s ease-out .15s both}

/* 响应式调整 */
@media(max-width:768px){
  .product-grid{grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:1rem}
  .product-info{padding:.75rem}
  .product-name{font-size:.9rem}
  .product-price{font-size:1rem}
  .add-to-cart{padding:.5rem 0;font-size:.9rem}
}
</style>
</head>

<body>
<header>
  <div class="logo">
    <svg viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
    BuyZu 商品列表
  </div>
  <div class="cart-icon" onclick="location.href='shoppingCart.html'">
    <svg viewBox="0 0 24 24"><path d="M7 4h-2l-3 7v2h2l2-4h11l1.2 3H20v2h-2l-1-3H8l-1 2H3v-2l3-7zM6 18a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm10 0a2 2 0 1 0 .001 3.999A2 2 0 0 0 16 18z"/></svg>
    <span class="cart-count" id="cartCount">0</span>
  </div>
</header>

<main>
  <section>
    <div class="section-head">
      <h2>热门商品</h2>
    </div>

    <div class="product-grid" id="productGrid">
      <!-- 商品将通过JS动态加载 -->
    </div>
  </section>
</main>

<!-- ============ 脚本 ============ -->
<script>
/* ---------- 常量 ---------- */
const API_PRODUCTS = '/api/products';
const API_CART = '/api/cart';
const productGrid = document.getElementById('productGrid');
const cartCountElement = document.getElementById('cartCount');

// 示例商品数据
const DEMO_PRODUCTS = [
  {
    product_id: '1',
    name: 'Apple AirPods Pro (2nd Generation)',
    brandName: 'Apple',
    price: 1899.00,
    img: 'p1.jpeg'
  },
  {
    product_id: '6',
    name: 'Sony WF-1000XM5 真无线降噪耳机',
    brandName: 'Sony',
    price: 1599.00,
    img: 'p6.jpeg'
  },
  {
    product_id: '21',
    name: 'HUAWEI FreeClip 开放式无线耳机',
    brandName: 'HUAWEI',
    price: 1199.00,
    img: 'p21.jpeg'
  },
  {
    product_id: '24',
    name: 'Xiaomi REDMIBuds 6 Pro',
    brandName: 'Xiaomi',
    price: 339.00,
    img: 'p24.jpeg'
  },
  {
    product_id: '15',
    name: 'Beats Studio Buds+',
    brandName: 'Beats',
    price: 899.00,
    img: 'p15.jpeg'
  },
  {
    product_id: '44',
    name: 'Shokz OpenRun Pro 2 S820',
    brandName: 'Shokz',
    price: 1268.00,
    img: 'p44.jpeg'
  }
];

let products = [];
let isDemo = true; // 标记是否使用演示数据
let cartItems = [];

/* ---------- Cookie ---------- */
function getCookie(n){const m=document.cookie.match('(?:^|; )'+n+'=([^;]+)');return m?decodeURIComponent(m[1]):null;}
function setCookie(n,v,d=365){document.cookie=`${n}=${encodeURIComponent(v)}; expires=${new Date(Date.now()+d*864e5).toUTCString()}; path=/`;} 
function genAnon(){return 'sess_'+Date.now().toString(36)+'_'+Math.random().toString(16).slice(2,6);}

/* ---------- 加载商品数据 ---------- */
async function loadProducts() {
  try {
    // 尝试从API获取商品数据
    try {
      const res = await fetch(API_PRODUCTS);
      
      if (res.ok) {
        products = await res.json();
        isDemo = false;
      } else {
        // 如果API请求失败，使用演示数据
        console.log('使用演示数据展示商品');
        products = [...DEMO_PRODUCTS];
        isDemo = true;
      }
    } catch (error) {
      // 如果API请求出错，使用演示数据
      console.log('API连接失败，使用演示数据', error);
      products = [...DEMO_PRODUCTS];
      isDemo = true;
    }
    
    renderProducts();
    loadCartCount();
  } catch (error) {
    console.error('加载商品失败:', error);
  }
}

/* ---------- 渲染商品列表 ---------- */
function renderProducts() {
  if (!products || products.length === 0) {
    productGrid.innerHTML = '<p class="fade-in">暂无商品数据</p>';
    return;
  }

  let html = '';
  
  products.forEach((product, index) => {
    const delay = index < 12 ? index * 0.05 : 0; // 前12个商品添加延迟动画
    html += `
      <div class="product-card fade-in" style="animation-delay: ${delay}s">
        <div class="product-img">
          <img src="${isDemo ? `https://picsum.photos/id/${product.product_id*10}/500` : `/images/${product.img || 'default.jpg'}`}" alt="${product.name}">
        </div>
        <div class="product-info">
          <div class="product-brand">${product.brandName || ''}</div>
          <div class="product-name">${product.name}</div>
          <div class="product-price">￥${(+product.price).toFixed(2)}</div>
          <button class="add-to-cart" onclick="addToCart('${product.product_id}', this)">
            加入购物车
          </button>
        </div>
      </div>
    `;
  });

  productGrid.innerHTML = html;
}

/* ---------- 添加商品到购物车 ---------- */
async function addToCart(productId, buttonElement) {
  // 确保有会话ID
  let sessionId = localStorage.getItem('userID') || getCookie('cart_session');
  if (!sessionId) {
    sessionId = genAnon();
    localStorage.setItem('userID', sessionId);
    setCookie('cart_session', sessionId);
  }
  
  if (!isDemo) {
    try {
      const res = await fetch(API_CART, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-SessionID': sessionId
        },
        body: JSON.stringify({ product_id: productId, quantity: 1 })
      });
      
      if (!res.ok) {
        const errorData = await res.json();
        alert(errorData.message || '添加失败，请稍后重试');
        return;
      }
    } catch (error) {
      console.error('添加到购物车失败:', error);
      alert('网络错误，请稍后重试');
      return;
    }
  } else {
    // 演示模式下，直接更新本地数据
    const existingItem = cartItems.find(item => item.product_id === productId);
    if (existingItem) {
      existingItem.quantity += 1;
    } else {
      const product = products.find(p => p.product_id === productId);
      if (product) {
        cartItems.push({
          product_id: product.product_id,
          name: product.name,
          brandName: product.brandName,
          price: product.price,
          img: product.img,
          quantity: 1,
          checked: true
        });
      }
    }
    
    // 保存到localStorage以便购物车页面使用
    localStorage.setItem('demoCartItems', JSON.stringify(cartItems));
  }
  
  // 更新按钮状态
  buttonElement.textContent = '已加入';
  buttonElement.classList.add('added');
  setTimeout(() => {
    buttonElement.textContent = '加入购物车';
    buttonElement.classList.remove('added');
  }, 2000);
  
  // 更新购物车数量
  updateCartCount();
}

/* ---------- 加载购物车数量 ---------- */
async function loadCartCount() {
  if (isDemo) {
    // 从localStorage加载演示购物车数据
    try {
      const savedCart = localStorage.getItem('demoCartItems');
      if (savedCart) {
        cartItems = JSON.parse(savedCart);
        updateCartCount();
      }
    } catch (error) {
      console.error('加载购物车数据失败:', error);
    }
    return;
  }
  
  try {
    const sessionId = localStorage.getItem('userID') || getCookie('cart_session');
    if (!sessionId) return;
    
    const res = await fetch(API_CART, {
      headers: { 'X-SessionID': sessionId }
    });
    
    if (res.ok) {
      const data = await res.json();
      cartItems = data;
      updateCartCount();
    }
  } catch (error) {
    console.error('获取购物车数量失败:', error);
  }
}

/* ---------- 更新购物车数量显示 ---------- */
function updateCartCount() {
  const count = cartItems.reduce((sum, item) => sum + item.quantity, 0);
  cartCountElement.textContent = count;
  
  // 如果数量为0，隐藏数字
  cartCountElement.style.display = count > 0 ? 'flex' : 'none';
}

/* ---------- 初始化 ---------- */
document.addEventListener('DOMContentLoaded', loadProducts);
</script>
</body>
</html>
